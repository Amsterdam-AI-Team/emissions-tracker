# emissions_tracking

This repo serves as a demo of how we track emissions within the AI Lab of the municipality of Amsterdam.


## Background

As the AI Lab we would like to be able to track the climate impact (CI) of (the modelling part of) our projects. 
This is because development and usage of AI models can cause significant environmental impact.
The goal of tracking is to facilitate:

- Awareness
    - We want to create awareness, for ourselves and for users, what the environmental impact of the AI model is
- Reduction
    - Identifying what the relative impact of different parts of the process is allows for focused optimization and impact reduction
- Comparison
    - When an AI system is proposed, insight in the environmental impact can help in (the discussion about) the benefits vs. (environmental) costs 

## Folder Structure

* [`notebooks`](./notebooks): Jupyter notebooks / tutorials

## Installation 

1) Clone this repository:

```bash
git clone https://github.com/Amsterdam-AI-Team/emissions_tracking.git
```




2) Install all dependencies:
    


```bash
pip install -r requirements.txt
```



The code has been tested with Python 3.10 on Windows & Linux. 

## Usage

## How it works

To track the carbon emissions of our projects, we use [CodeCarbon](https://mlco2.github.io/codecarbon/index.html), a Python package that estimates your hardware electricity power consumption (GPU + CPU + RAM) and applies it to the carbon intensity of the region where the computing is done.

![image](https://github.com/user-attachments/assets/1fbab07d-a908-4ae2-a0ff-77b12a78fd6e)


More specifically it does it as following:

### Calculate the Carbon Intensity of the local energy grid

Carbon intensity is calculated as weighted average of emissions from different energy sources used to generate electricity.

Codecarbon attempts to retrieve carbon intensity based on location.

When available, CodeCarbon uses global carbon intensity of electricity per cloud provider or per country.

When it doesn‚Äôt have the carbon intensity, but has the energy mix, it computes the carbon intensity

If it has neither, it uses a world average of `475 gCO2.eq/kWh `

![image](https://github.com/user-attachments/assets/4ab51280-a6b5-4849-b333-45e0bc5c9a4f)


### Power Usage

CodeCarbon attempts to establish and track the power usage of the resources (CPU/GPU/RAM) used to run your code.

By default it checks it every 15 seconds.

#### CPU
For CPU it uses tracking tools if they are available. Which tracking tool is dependent on your OS.

- Windows&Mac Intel > Intel Power Gadget (need to [install](https://www.intel.com/content/www/us/en/developer/articles/tool/power-gadget.html))
- M-chip Mac > powermetrics (native on any Mac)
- Linux > RAPL (Running Average Power Limit) files

If no tracking tools are available it switches to **fallback** mode:
- Detect CPU Hardware > Map to Termal Design Power (TDP)
- If CPU can‚Äôt be mapped use global constant
- Assume 50% average power consumption

Note: Tracking tools are currently unavailable for managed devices of the municipality of Amsterdam. Azure also does not allow access to specific resource usage statistics, so for both these options CodeCarbon will run in **fallback** mode. (TODO: Check access to RAPL files in WSL.)

#### GPU
- Tracks Nvidia GPUs energy consumption using `pynvml` library

#### RAM 
- CodeCarbon uses a 3 Watts for 8GB ratio.

### Tracking your emissions

To get an experiment_id enter:

```! codecarbon init```
You can now store it in a `.codecarbon.config` at the root of your project

```[codecarbon]
log_level = DEBUG
save_to_api = True
experiment_id = 2bcbcbb8-850d-4692-af0d-76f6f36d79b2 #the experiment_id you get with init
```
Now you have 2 main options:

#### Monitoring your machine üíª

In your command prompt use: `codecarbon monitor`.
The package will track your emissions independently from your code.

#### In your Python code üêç
```
from codecarbon import track_emissions
@track_emissions()
def your_function_to_track():
  # your code
```
The package will track the emissions generated by the execution of your function.

More options are presented in the notebook in this repo.

### Output
#### Logger
CodeCarbon has a built in logger that logs automatically into a `.csv`. It contains info such as:
`Project_name`, `Emissions`, `Energy_consumed`, `Cloud_region`, etc.

#### Dashboard
CodeCarbon comes with a `Dash App` where the emissions are visualized.

To host it locally it, we execute the CLI command below:

`carbonboard --filepath="emissions.csv" --port=3333`

![image](https://github.com/user-attachments/assets/5e374298-7d84-4104-bc1c-a55a98b070ea)
![image](https://github.com/user-attachments/assets/136f32fe-a5d2-45bd-a9bc-841d77a87597)

## Contributing

Feel free to help out! [Open an issue](https://github.com/Amsterdam-AI-Team/emissions_tracking/issues), submit a [PR](https://github.com/Amsterdam-AI-Team/emissions_tracking/pulls) or [contact us](https://amsterdamintelligence.com/contact/).




## Acknowledgements

This repository was created by [Amsterdam Intelligence](https://amsterdamintelligence.com/) for the City of Amsterdam.

It mainly serves as a guide/example on how to use [CodeCarbon](https://github.com/mlco2/codecarbon).
For more detailed information, check out their [documentation](https://mlco2.github.io/codecarbon/index.html).



## License 

This project is licensed under the terms of the European Union Public License 1.2 (EUPL-1.2).
